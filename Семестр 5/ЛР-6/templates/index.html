<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö—É—Ä—Å –≤–∞–ª—é—Ç (Observer)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #rates { margin-top: 20px; }
        .rate { font-size: 1.2em; margin: 5px 0; }
        .updated { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>üîî –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –∫—É—Ä—Å–∞–º–∏ –≤–∞–ª—é—Ç</h1>
    <p><strong>–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞:</strong> <code id="client-id">‚Äî</code></p>
    <div id="rates">
        <p>–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>

    <script>
        const ws = new WebSocket(`ws://${location.host}/ws`);
        const clientIdEl = document.getElementById('client-id');
        const ratesEl = document.getElementById('rates');

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'welcome') {
                clientIdEl.textContent = data.client_id;
                updateRates(data.rates, data.last_update);
            } else if (data.type === 'update') {
                updateRates(data.rates, data.timestamp);
            }
        };

        function updateRates(rates, timestamp) {
            let html = '';
            for (const [code, value] of Object.entries(rates)) {
                html += `<div class="rate">${code}: <strong>${value.toFixed(4)}</strong></div>`;
            }
            if (timestamp) {
                const date = new Date(timestamp);
                html += `<div class="updated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${date.toLocaleString()}</div>`;
            }
            ratesEl.innerHTML = html;
        }

        ws.onerror = () => {
            ratesEl.innerHTML = '<p style="color:red">‚ö†Ô∏è –û—à–∏–±–∫–∞ WebSocket</p>';
        };

        ws.onclose = () => {
            ratesEl.innerHTML += '<p style="color:orange">‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ</p>';
        };
    </script>
</body>
</html>